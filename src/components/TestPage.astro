<portal-gate to="end:head">
  <script is:inline>
    function getBrowserAndVersion() {
      const ua = navigator.userAgent;

      let match = ua.match(/OPR\/([\d.]+)/);
      if (match) return { name: "Opera", version: match[1] };

      match = ua.match(/Opera\/([\d.]+)/);
      if (match) {
        let versionMatch = ua.match(/Version\/([\d.]+)/);
        return {
          name: "Opera",
          version: versionMatch ? versionMatch[1] : match[1],
        };
      }

      match = ua.match(/Firefox\/([\d.]+)/);
      if (match) return { name: "Firefox", version: match[1] };

      match = ua.match(/Edg\/([\d.]+)/);
      if (match) return { name: "Edge", version: match[1] };

      match = ua.match(/Chrome\/([\d.]+)/);
      if (match && !ua.includes("Edg") && !ua.includes("OPR"))
        return { name: "Chrome", version: match[1] };

      match = ua.match(/Version\/([\d.]+).*Safari/);
      if (match && !ua.includes("Chrome") && !ua.includes("Chromium"))
        return { name: "Safari", version: match[1] };

      return { name: ua, version: "" };
    }

    addEventListener("pagereveal", (e) => {
      e.viewTransition?.ready.then(() => {
        const as = document.getAnimations();
        as.forEach((a) => {
          a.effect.pseudoElement === "::view-transition-group-children(root)" &&
            document.documentElement.setAttribute("_vtgc", "x");
        });
      });
    });

    addEventListener("pageswap", (e) => {
      sessionStorage.removeItem("vtbag-pageswap-idx");
      (e.activation?.entry?.index ?? -1 !== -1) &&
        sessionStorage.setItem("vtbag-pageswap-idx", "x");
    });
    addEventListener("load", () => {
      setTimeout(async () => {
        if (!sessionStorage.getItem("vtbag-test-page")) {
          sessionStorage.setItem("vtbag-test-page", "x");
          location.href = "/basics/test-page/";
        } else {
          sessionStorage.removeItem("vtbag-test-page");
          if (document.startViewTransition) {
            let matchElement = true;
            await document.startViewTransition().ready;
            document.getAnimations().forEach((a) => {
              if (a.animationName === "no-match-element") matchElement = false;
            });
            document.documentElement.setAttribute("sdvt", "");
            matchElement && document.documentElement.setAttribute("vtnme", "");
          }
          "onpageswap" in window &&
            document.documentElement.setAttribute("cdvt", "");
          "activeViewTransition" in document &&
            document.documentElement.setAttribute("avt", "");
          sessionStorage.getItem("vtbag-pageswap-idx") &&
            document.documentElement.setAttribute("idx", "");
          CSS.supports("view-transition-class", "mine") &&
            document.documentElement.setAttribute("vtc", "");
          CSS.supports("view-transition-group", "g") &&
            document.documentElement.setAttribute("vtg", "");
          document.documentElement.getAttribute("_vtgc") &&
            document.documentElement.setAttribute("vtgc", "");
          document.documentElement.getAttribute("_vtnme") &&
            document.documentElement.setAttribute("vtnme", "");
          document.body.startViewTransition &&
            document.documentElement.setAttribute("svt", "");
          "navigation" in window &&
            document.documentElement.setAttribute("nav", "");
          "prerendering" in document &&
            document.documentElement.setAttribute("spec", "");

          const browserInfo = getBrowserAndVersion();
          document.querySelector("#browser").textContent =
            "(" +
            browserInfo.name +
            " " +
            browserInfo.version.replace(/(\.0)+$/, "") +
            ") ";
          history.replaceState(history.state, "", "/basics/test-page/");
        }
      }, 1000);
    });
  </script>
</portal-gate>
<style is:global>
  .test {
    view-transition-name: test;
    view-transition-group: root;
  }
  .test-match-element {
    view-transition-name: match-element;
  }
  ::view-transition-group-children(root) {
    animation-name: -ua-view-transition-fade-out;
    animation-duration: 0.25s;
  }
  ::view-transition-new(match-element) {
    animation-name: no-match-element;
  }
  @keyframes no-match-element {
  }
</style>
